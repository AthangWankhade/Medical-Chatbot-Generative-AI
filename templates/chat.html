<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MediBot Chat</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Simple scrollbar for chat */
      #chat-box::-webkit-scrollbar,
      #sidebar-content::-webkit-scrollbar {
        width: 6px;
      }
      #chat-box::-webkit-scrollbar-thumb,
      #sidebar-content::-webkit-scrollbar-thumb {
        background-color: #4b5563; /* gray-600 */
        border-radius: 20px;
      }
    </style>
  </head>
  <body class="bg-gray-900 text-white font-sans">
    <div class="flex h-screen">
      <!-- Sidebar -->
      <div class="w-64 bg-gray-800 p-4 flex flex-col flex-shrink-0">
        <h1 class="text-2xl font-bold mb-4 flex-shrink-0">MediBot</h1>
        <a
          href="{{ url_for('new_chat') }}"
          class="w-full text-left bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-4 rounded-lg transition duration-200 mb-4 flex-shrink-0"
        >
          + New Chat
        </a>

        <!-- Chat History List -->
        <div class="flex flex-col flex-1 overflow-y-auto" id="sidebar-content">
          <h2
            class="text-sm font-semibold text-gray-400 uppercase tracking-wide mb-2"
          >
            Chat History
          </h2>
          <nav class="flex-1 space-y-1">
            <!-- 
                    Iterate over the chat_summaries passed from Flask.
                    Highlight the current_chat_id.
                    -->
            {% for chat in chat_summaries %}
            <a
              href="{{ url_for('load_chat', chat_id=chat.id) }}"
              class="w-full text-left block py-2 px-3 rounded-lg transition duration-200 truncate {% if chat.id == current_chat_id %} bg-gray-700 text-white {% else %} text-gray-300 hover:bg-gray-700 hover:text-white {% endif %}"
              title="{{ chat.title }}"
            >
              {{ chat.title }}
            </a>
            {% endfor %}
          </nav>
        </div>
      </div>

      <!-- Main Chat Area -->
      <div class="flex-1 flex flex-col">
        <!-- Chat Header -->
        <header class="bg-gray-800 p-4 text-lg font-semibold shadow-md z-10">
          MediBot Assistant
        </header>

        <!-- Chat Messages -->
        <main id="chat-box" class="flex-1 p-4 overflow-y-auto bg-gray-900">
          <div class="max-w-3xl mx-auto">
            <!--
                    Messages will be rendered here by the template engine.
                    This part remains the same.
                    -->
            {% for message in chat_history %} {% if message.role == 'user' %}
            <div class="mb-4 flex justify-end">
              <div class="bg-blue-600 text-white rounded-lg p-3 max-w-lg">
                <pre class="font-sans whitespace-pre-wrap">
{{ message.content }}</pre
                >
              </div>
            </div>
            {% else %}
            <!-- 'assistant' -->
            <div class="mb-4 flex justify-start">
              <div class="bg-gray-700 text-white rounded-lg p-3 max-w-lg">
                <pre class="font-sans whitespace-pre-wrap">
{{ message.content }}</pre
                >
              </div>
            </div>
            {% endif %} {% endfor %}

            <!-- This is where new messages will be appended by JS -->
            <div id="chat-end"></div>
          </div>
        </main>

        <!-- Input Bar -->
        <footer class="bg-gray-800 p-4 shadow-inner">
          <div class="max-w-3xl mx-auto">
            <form id="chat-form" class="flex items-center space-x-2">
              <input
                type="text"
                id="message-input"
                placeholder="Ask your medical question..."
                class="flex-1 p-3 bg-gray-700 text-white border border-gray-600 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                autocomplete="off"
              />
              <button
                type="submit"
                id="send-button"
                class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-5 rounded-lg transition duration-200"
              >
                Send
              </button>
            </form>
          </div>
        </footer>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const chatBox = document.getElementById("chat-box");
        const chatForm = document.getElementById("chat-form");
        const messageInput = document.getElementById("message-input");
        const sendButton = document.getElementById("send-button");
        const chatEnd = document.getElementById("chat-end");

        // Helper function to scroll to the bottom
        function scrollToBottom() {
          chatEnd.scrollIntoView({ behavior: "smooth" });
        }

        // Scroll to bottom on page load
        scrollToBottom();

        // Helper function to append a message to the chat UI
        function appendMessage(role, content) {
          const messageDiv = document.createElement("div");
          messageDiv.classList.add("mb-4", "flex");

          const contentDiv = document.createElement("div");
          contentDiv.classList.add("rounded-lg", "p-3", "max-w-lg");

          // Use <pre> to respect newlines and formatting for both user and bot
          const pre = document.createElement("pre");
          pre.classList.add("font-sans", "whitespace-pre-wrap");
          pre.textContent = content;

          if (role === "user") {
            messageDiv.classList.add("justify-end");
            contentDiv.classList.add("bg-blue-600", "text-white");
          } else {
            // assistant
            messageDiv.classList.add("justify-start");
            contentDiv.classList.add("bg-gray-700", "text-white");
          }

          contentDiv.appendChild(pre);
          messageDiv.appendChild(contentDiv);
          chatEnd.before(messageDiv); // Insert before the 'chat-end' anchor
        }

        // Handle form submission
        chatForm.addEventListener("submit", async (e) => {
          e.preventDefault();
          const message = messageInput.value.trim();
          if (!message) return;

          // 1. Display user message
          appendMessage("user", message);
          messageInput.value = "";
          scrollToBottom();

          // 2. Show loading state
          sendButton.disabled = true;
          sendButton.textContent = "...";

          try {
            // 3. Send message to backend
            // The /get endpoint will automatically use the current chat
            // ID stored in the session by the backend.
            const response = await fetch("/get", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ msg: message }),
            });

            if (!response.ok) {
              const errorData = await response.json();
              throw new Error(
                errorData.details || "Network response was not ok"
              );
            }

            const data = await response.json();

            // 4. Display bot response
            appendMessage("assistant", data.answer);

            // 5. Check if this is the first message of a new chat
            // If so, we need to refresh the sidebar to show the new title
            const sidebarNav = document.querySelector("nav");
            const firstChatTitle = sidebarNav.querySelector("a > pre");
            if (firstChatTitle && firstChatTitle.textContent === "New Chat") {
              // This is a simple way to reload the page and update the sidebar
              // A more advanced (but complex) solution would use JS
              // to fetch summaries and rebuild the nav.
              window.location.reload();
            }
          } catch (error) {
            console.error("Error:", error);
            appendMessage(
              "assistant",
              "Sorry, something went wrong. " + error.message
            );
          } finally {
            // 6. Restore button state
            sendButton.disabled = false;
            sendButton.textContent = "Send";
            scrollToBottom();
          }
        });
      });
    </script>
  </body>
</html>
