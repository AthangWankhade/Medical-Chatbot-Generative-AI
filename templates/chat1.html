<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI Chatbot</title>

    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0&family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0"
    />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
    <style>
      /* tiny helper styles so icons toggle nicely if your CSS doesn't */
      #chatbot-toggler .material-symbols-rounded.close { display:none; }
      .chatbot-popup.open #chatbot-toggler .material-symbols-rounded.close { display:inline; }
      .chatbot-popup.open #chatbot-toggler .material-symbols-outlined { display:none; }
    </style>
  </head>
  <body>
    <button id="chatbot-toggler" aria-label="Open chatbot">
      <span class="material-symbols-outlined">mode_comment</span>
      <span class="material-symbols-rounded close">close</span>
    </button>

    <div class="chatbot-popup" aria-hidden="true">
      <!-- Chatbot Header -->
      <div class="chat-header">
        <div class="header-info">
          <svg
            class="chatbot-logo"
            xmlns="http://www.w3.org/2000/svg"
            width="50"
            height="50"
            viewBox="0 0 1024 1024"
          >
            <path
              d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5zM867.2 644.5V453.1h26.5c19.4 0 35.1 15.7 35.1 35.1v121.1c0 19.4-15.7 35.1-35.1 35.1h-26.5zM95.2 609.4V488.2c0-19.4 15.7-35.1 35.1-35.1h26.5v191.3h-26.5c-19.4 0-35.1-15.7-35.1-35.1zM561.5 149.6c0 23.4-15.6 43.3-36.9 49.7v44.9h-30v-44.9c-21.4-6.5-36.9-26.3-36.9-49.7 0-28.6 23.3-51.9 51.9-51.9s51.9 23.3 51.9 51.9z"
            ></path>
          </svg>

          <h2 class="logo-text">Chatbot</h2>
        </div>
        <button id="close-chatbot" class="material-symbols-rounded" aria-label="Minimize chatbot">
          keyboard_arrow_down
        </button>
      </div>

      <!-- Chatbot Body -->
      <div class="chat-body" id="chat-body" role="log" aria-live="polite">
        <div class="message bot-message">
          <svg
            class="bot-avatar"
            xmlns="http://www.w3.org/2000/svg"
            width="50"
            height="50"
            viewBox="0 0 1024 1024"
          >
            <path
              d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5z"
            ></path>
          </svg>
          <div class="message-text">
            Hey there ðŸ‘‹ <br />
            How can I help you today?
          </div>
        </div>
      </div>

      <!-- Chatbot Footer -->
      <div class="chat-footer">
        <form id="chat-form" class="chat-form" action="#" autocomplete="off">
          <textarea
            id="message-input"
            name="msg"
            placeholder="Message..."
            class="message-input"
            rows="2"
            required
          ></textarea>
          <div class="chat-controls">
            <button
              type="button"
              id="emoji-picker"
              class="material-symbols-rounded"
              title="Emoji (not implemented)"
            >
              sentiment_satisfied
            </button>

            <div class="file-upload-wrapper">
              <input type="file" accept="images/*" id="file-input" hidden />
              <button
                type="button"
                id="file-upload"
                class="material-symbols-rounded"
                title="Attach file (not uploaded to server)"
              >
                attach_file
              </button>
            </div>

            <button
              type="submit"
              id="send-message"
              class="material-symbols-rounded"
              title="Send"
            >
              arrow_upward
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- optional emoji mart script (kept, but not required) -->
    <script src="https://cdn.jsdelivr.net/npm/emoji-mart@latest/dist/browser.js"></script>

    <!-- Inline JS: no external script.js required -->
    <script>
      (function () {
        // Elements
        const toggler = document.getElementById("chatbot-toggler");
        const popup = document.querySelector(".chatbot-popup");
        const closeBtn = document.getElementById("close-chatbot");
        const chatBody = document.getElementById("chat-body");
        const form = document.getElementById("chat-form");
        const input = document.getElementById("message-input");
        const fileUploadBtn = document.getElementById("file-upload");
        const fileInput = document.getElementById("file-input");

        // Toggle open/close
        toggler.addEventListener("click", () => {
          popup.classList.toggle("open");
          const isOpen = popup.classList.contains("open");
          popup.setAttribute("aria-hidden", !isOpen);
          toggler.setAttribute("aria-expanded", isOpen);
          if (isOpen) {
            // focus the input when opened
            setTimeout(() => input.focus(), 100);
          }
        });

        // minimize button
        closeBtn.addEventListener("click", () => {
          popup.classList.remove("open");
          popup.setAttribute("aria-hidden", "true");
          toggler.setAttribute("aria-expanded", "false");
        });

        // file upload (UI only)
        fileUploadBtn.addEventListener("click", () => fileInput.click());
        fileInput.addEventListener("change", () => {
          const file = fileInput.files[0];
          if (!file) return;
          // show a preview message but do NOT upload (you can extend this)
          addMessage("user", `ðŸ“Ž Attached ${file.name}`);
          fileInput.value = "";
        });

        // helper to append messages
        function addMessage(sender, text) {
          const wrapper = document.createElement("div");
          wrapper.className = "message " + (sender === "bot" ? "bot-message" : "user-message");

          if (sender === "bot") {
            // bot avatar + text
            wrapper.innerHTML = `
              <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024"><path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9zM351.7 448.2c0-29.5 23.9-53.5 53.5-53.5s53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5-53.5-23.9-53.5-53.5zm157.9 267.1c-67.8 0-123.8-47.5-132.3-109h264.6c-8.6 61.5-64.5 109-132.3 109zm110-213.7c-29.5 0-53.5-23.9-53.5-53.5s23.9-53.5 53.5-53.5 53.5 23.9 53.5 53.5-23.9 53.5-53.5 53.5z"/></svg>
              <div class="message-text">${escapeHtml(text).replace(/\n/g, "<br/>")}</div>
            `;
          } else {
            // user message (no avatar)
            wrapper.innerHTML = `<div class="message-text">${escapeHtml(text).replace(/\n/g, "<br/>")}</div>`;
          }

          chatBody.appendChild(wrapper);
          // scroll to bottom
          chatBody.scrollTop = chatBody.scrollHeight;
        }

        // small escape helper to avoid injected HTML
        function escapeHtml(s) {
          if (!s) return "";
          return s
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
        }

        // show typing indicator and return a function to remove it
        function showTyping() {
          const el = document.createElement("div");
          el.className = "message bot-message typing";
          el.innerHTML = `
            <svg class="bot-avatar" xmlns="http://www.w3.org/2000/svg" width="50" height="50" viewBox="0 0 1024 1024"><path d="M738.3 287.6H285.7c-59 0-106.8 47.8-106.8 106.8v303.1c0 59 47.8 106.8 106.8 106.8h81.5v111.1c0 .7.8 1.1 1.4.7l166.9-110.6 41.8-.8h117.4l43.6-.4c59 0 106.8-47.8 106.8-106.8V394.5c0-59-47.8-106.9-106.8-106.9z"/></svg>
            <div class="message-text">...</div>
          `;
          chatBody.appendChild(el);
          chatBody.scrollTop = chatBody.scrollHeight;
          return () => {
            el.remove();
          };
        }

        // send message handler
        async function sendMessage(text) {
          const trimmed = text && text.trim();
          if (!trimmed) return;

          addMessage("user", trimmed);
          input.value = "";
          input.focus();

          const removeTyping = showTyping();

          try {
            const resp = await fetch("/get", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ msg: trimmed }),
            });

            if (!resp.ok) {
              throw new Error("Network response was not ok: " + resp.status);
            }

            const data = await resp.json();
            const answer = data.answer ?? JSON.stringify(data);
            removeTyping();
            addMessage("bot", answer);
          } catch (err) {
            removeTyping();
            addMessage("bot", "Sorry â€” something went wrong. " + (err.message || ""));
            console.error(err);
          }
        }

        // form submit
        form.addEventListener("submit", (e) => {
          e.preventDefault();
          sendMessage(input.value);
        });

        // Enter to send, Shift+Enter for newline
        input.addEventListener("keydown", (e) => {
          if (e.key === "Enter" && !e.shiftKey) {
            e.preventDefault();
            form.requestSubmit();
          }
        });

        // accessibility: focus on input when popup opened via keyboard
        toggler.addEventListener("keydown", (e) => {
          if ((e.key === "Enter" || e.key === " ") && !popup.classList.contains("open")) {
            e.preventDefault();
            toggler.click();
          }
        });
      })();
    </script>
  </body>
</html>
